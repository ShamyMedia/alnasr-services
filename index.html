<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ù„ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø¨Ø±Ø¬ Ø§Ù„Ù†ØµØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === 1. CSS Styles (Ø§Ù„ØªØµÙ…ÙŠÙ…) === */
        :root {
            --primary: #007bff;
            --success: #28a745;
            --wa-color: #25D366;
            --map-color: #dc3545;
            --bg: #f0f2f5;
            --card-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        body { background-color: var(--bg); margin: 0; font-family: 'Cairo', sans-serif; }
        
        header { 
            position: sticky; top: 0; z-index: 100; background: #fff; 
            padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }

        .search-box input {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #ddd; font-family: 'Cairo'; font-size: 1rem;
        }

        main { padding: 15px; }

        .card {
            background: #fff; border-radius: 20px; padding: 18px;
            margin-bottom: 20px; box-shadow: var(--card-shadow);
        }

        .card-header { display: flex; gap: 15px; align-items: center; }

        .thumb { width: 75px; height: 75px; border-radius: 15px; object-fit: cover; background: #eee; }

        .info h2 { margin: 0; font-size: 1.1rem; color: #1a1a1a; }

        .category-badge {
            background: #e9ecef; padding: 4px 10px; border-radius: 8px;
            font-size: 0.8rem; color: #495057; display: inline-block; margin-top: 5px;
        }

        .distance-badge { background: #e7f1ff; color: var(--primary); font-weight: bold; }

        .desc { font-size: 0.9rem; color: #555; margin: 12px 0; }

        .actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .btn {
            text-decoration: none; padding: 10px 5px; border-radius: 12px;
            text-align: center; font-size: 0.8rem; font-weight: 700;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }

        .btn-call { border: 1.5px solid var(--primary); color: var(--primary); }
        .btn-wa { background: var(--wa-color); color: #fff; }
        .btn-map { border: 1.5px solid var(--map-color); color: var(--map-color); }

        .empty { text-align: center; padding: 50px; color: #888; }
    </style>
</head>
<body>

    <header>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨ÙŠØ¨ØŒ ØªØ®ØµØµØŒ Ø£Ùˆ Ø®Ø¯Ù…Ø©..." oninput="handleSearch()">
        </div>
    </header>

    <main id="list-container">
        </main>

    <script>
        /* === 2. JavaScript (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ) === */
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbwGZjfCiI2x2Q2sBT3ZY8CKfKBqKCVF6NFVqYcjvyAR84CkDShrdx5_2onSU4SlVz6GDQ/exec",
            CACHE_KEY: "alnasr_v2_data"
        };

        let allServices = [];
        let userLocation = null;

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
        function normalizeArabic(text) {
            if (!text) return "";
            return text.toString().toLowerCase()
                .replace(/[Ø£Ø¥Ø¢]/g, "Ø§").replace(/Ø©/g, "Ù‡").replace(/[Ù‰ÙŠ]/g, "ÙŠ")
                .replace(/[\u064B-\u0652]/g, ""); 
        }

        function handleSearch() {
            const query = normalizeArabic(document.getElementById('searchInput').value);
            const filtered = allServices.filter(s => 
                normalizeArabic(s.name).includes(query) || 
                normalizeArabic(s.category).includes(query) ||
                normalizeArabic(s.description).includes(query)
            );
            renderUI(filtered);
        }

        function renderUI(data) {
            const container = document.getElementById('list-container');
            container.innerHTML = data.length ? "" : "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>";

            data.forEach(s => {
                let distHTML = "";
                if(userLocation && s.lat && s.lng) {
                    const d = calculateDistance(userLocation.lat, userLocation.lng, s.lat, s.lng);
                    distHTML = `<span class="category-badge distance-badge">${d} ÙƒÙ… Ø¨Ø¹ÙŠØ¯ Ø¹Ù†Ùƒ</span>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <img src="${s.image || 'https://i.postimg.cc/fyqVj003/s001.webp'}" class="thumb" loading="lazy">
                        <div class="info">
                            <h2>${s.name}</h2>
                            <span class="category-badge">${s.category}</span>
                            ${distHTML}
                        </div>
                    </div>
                    <p class="desc">${s.description || ''}</p>
                    <div class="actions">
                        <a href="tel:${s.phone}" class="btn btn-call"><span>ğŸ“</span>Ø§ØªØµØ§Ù„</a>
                        <a href="https://wa.me/2${s.whatsapp}" target="_blank" class="btn btn-wa"><span>ğŸ’¬</span>ÙˆØ§ØªØ³Ø§Ø¨</a>
                        <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" class="btn btn-map"><span>ğŸ“</span>Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
        }

        async function init() {
            const cached = localStorage.getItem(CONFIG.CACHE_KEY);
            if (cached) {
                allServices = JSON.parse(cached).data;
                renderUI(allServices);
            }

            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                renderUI(allServices);
            });

            try {
                const res = await fetch(CONFIG.API_URL);
                const json = await res.json();
                allServices = json.shops;
                localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({ data: allServices, time: Date.now() }));
                renderUI(allServices);
            } catch (e) { console.log("Offline mode"); }
        }

        init();
    </script>
</body>
</html>